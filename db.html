<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Indexed DB Test</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        padding: var(--padding);
      }
      h1 {
        color: var(--theme-main);
      }
      code p {
        padding: var(--padding);
        width: calc(100% - calc(var(--padding) + var(--padding)));
        border: var(--border-width) solid var(--border);
        border-radius: var(--rounding);
        background-color: var(--theme-bg-alt);
      }
    </style>
  </head>
  <body>
    <h1>Indexed DB Test</h1>
    <button id="openDatabase">Open Database</button>
    <button id="getSpecific">Get Specific: ("file1.txt")</button>
    <p></p>
    <code id="results"></code>
    <script>
      // Get a specific item from the IndexedDB database
      function getSpecific(store, path, file) {
        // Store is the top level "folder" to look in.
        // File points to the key pair in the path being read path.
        // Path is an array of the folders to navigate into.

        // Request the database
        let request = indexedDB.open("fileSystem");
        // On success, do the necessary actions in the closure
        request.onsuccess = function (event) {
          let db = event.target.result;
          console.log("Database opened successfully");

          // Get all records form the object store
          let transaction = db.transaction([store], "readonly");
          let objectStore = transaction.objectStore(store);
          console.log("Store: `" + store + "` Opened successfully");

          // Go to the top path
          console.log(path);
          if (path.length != 0) {
            // Get the key pair at top level
            let getRequest = objectStore.get(path[0]);
            getRequest.onsuccess = function (event) {
              let record = event.target.result;

              // Loop through every other dir in the path
              path.shift();
              for (let index = 0; index < path.length; index++) {
                const dir = path[index];
                console.log(record.dir);
              }
            };
            // Handle errors
            getRequest.onerror = function (event) {
              console.error("Error retrieving records:", event.target.error);
            };
          } else {
            // Getting
            let getRequest = objectStore.get(file);

            getRequest.onsuccess = function (event) {
              let record = event.target.result;
              console.log("Record is: " + record);
              return record; // Return the result
            };

            getRequest.onerror = function (event) {
              console.error("Error retrieving records:", event.target.error);
            };
          }
        };

        request.onerror = function (event) {
          console.error("Error opening the database:", event.target.error);
        };
      }
      // Open or create the IndexedDB database
      function openDatabase() {
        let request = indexedDB.open("fileSystem");

        request.onsuccess = function (event) {
          let db = event.target.result;
          console.log("Database opened successfully");

          // Get all records form the object store
          let transaction = db.transaction(["root"], "readonly");
          let objectStore = transaction.objectStore("root");
          let getAllRequest = objectStore.getAll();

          getAllRequest.onsuccess = function (event) {
            let records = event.target.result;
            displayResults(records); // Displays the results on page
          };

          getAllRequest.onerror = function (event) {
            console.error("Error retrieving records:", event.target.error);
          };
        };

        request.onerror = function (event) {
          console.error("Error opening the database:", event.target.error);
        };
      }

      // Display a record in the browser
      function displayResult(record) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = `<p>Record: ${JSON.stringify(record)}</p>`;
      }

      // Display the records in the browser
      function displayResults(records) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";
        if (records.length > 0) {
          records.forEach((record, index) => {
            resultsDiv.innerHTML += `<p>Record ${index}: ${JSON.stringify(
              record
            )}</p>`;
          });
        } else {
          resultsDiv.innerHTML = "<p>No records found.</p>";
        }
      }

      // Open database when button is clicked
      document
        .getElementById("openDatabase")
        .addEventListener("click", openDatabase);
      // Get a specific element when the button is clicked
      document
        .getElementById("getSpecific")
        .addEventListener("click", getSpecific);

      // Set up the data base with initial data
      window.onload = function () {
        let request = indexedDB.open("fileSystem");

        request.onupgradeneeded = function (event) {
          let db = event.target.result;
          if (!db.objectStoreNames.contains("root")) {
            let objectStore = db.createObjectStore("root", {
              keyPath: "file",
            });
            objectStore.add({
              file: "file1.txt",
              type: "file",
              contents: "Hello World!",
            });
            objectStore.add({
              file: "paragraph.html",
              type: "file",
              contents: new Blob(["<p>Paragraph</p>"], { type: "text/html" }),
            });
            objectStore.add({
              file: "dir",
              type: "directory",
              contents: [
                {
                  file: "file1.txt",
                  type: "file",
                  contents: "In a directory",
                },
                {
                  file: "file2.txt",
                  type: "file",
                  contents: "file",
                },
                {
                  file: "dir",
                  type: "directory",
                  contents: [
                    {
                      file: "text.java",
                      type: "file",
                      contents: "nested directories",
                    },
                  ],
                },
              ],
            });
          }
        };

        console.log("created initial db");
      };
    </script>
  </body>
</html>
